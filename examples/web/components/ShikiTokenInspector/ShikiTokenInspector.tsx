"use client";

import { Editor } from "@monaco-editor/react";
import { $ } from "migacss";
import dynamic from "next/dynamic";
import { useState } from "react";
import { AiFillGithub } from "react-icons/ai";
import { BsStars } from "react-icons/bs";
import { RiShareBoxLine } from "react-icons/ri";
import { defaultCode, supportedLangs } from "remark-shaku-code-annotate";
import * as shiki from "shiki";
import { Button, Column, Row, Text, View } from "../bare";

const CodeSnippetPreview = dynamic(() => import("./ShikiTokenPreview"), {
  ssr: false,
});

export function ShikiTokenInspector({
  code: _code,
  lang: _lang,
  theme: _theme,
}: {
  code?: string;
  lang?: string;
  theme?: shiki.Theme;
}) {
  const [lang, setLang] = useState<string>(_lang ?? "javascript");
  const [code, setCode] = useState(_code ?? defaultCode[lang] ?? "");
  const [theme, setTheme] = useState<shiki.Theme>(_theme ?? "github-dark");

  const share = () => {
    const query =
      "code=" + encodeURIComponent(code) + "&lang=" + encodeURIComponent(lang);
    const url = location.origin + "/shiki-token-inspector?" + query;
    const type = "text/plain";
    const blob = new Blob([url], { type });
    const data = [new ClipboardItem({ [type]: blob })];
    navigator.clipboard.write(data).then(
      () => alert("link copied"),
      () => alert("failed to copy link.")
    );
  };
  return (
    <Column $height={"100vh"} $padding={12} $gap={12}>
      <View>
        <Row $alignItems="center" $justifyContent="space-between" $gap={20}>
          <Text type="headline1">
            Shiki Token Inspector
            <$.a
              href="https://github.com/JSerZANP/shaku"
              target="_blank"
              $fontSize={20}
              $marginLeft={12}
            >
              <AiFillGithub />
            </$.a>
          </Text>
          <$.a href="/" $textDecoration="none">
            <Text type="headline5" $color="#0e67e4">
              <BsStars />
              Shaku â†’
            </Text>
          </$.a>
        </Row>
        <Text type="body">
          A tool to inspect the tokens generated by{" "}
          <a href="https://github.com/shikijs/shiki">shiki</a>. Created by{" "}
          <a href="https://twitter.com/JSer_ZANP">JSer</a>.
        </Text>
      </View>

      <Row $gap={20} $flex="1 0 0 " $minHeight={0}>
        <Column $flex="1 0 0" $maxWidth={500}>
          <Row $marginBottom="0.5rem">
            <select
              value={lang}
              // @ts-ignore
              onChange={(e) => {
                const newLang = e.currentTarget.value;
                setLang(newLang);
                setCode(defaultCode[newLang]);
              }}
            >
              {supportedLangs.map((lang) => (
                <option value={lang} key={lang}>
                  {lang}
                </option>
              ))}
            </select>
            <select
              // @ts-ignore
              value={theme}
              // @ts-ignore
              onChange={(e) => {
                // @ts-ignore
                setTheme(e.currentTarget.value);
              }}
            >
              {shiki.BUNDLED_THEMES.map((theme) => (
                <option value={theme} key={theme}>
                  {theme}
                </option>
              ))}
            </select>
            <Button
              onClick={share}
              label="Share with below code"
              icon={<RiShareBoxLine />}
            ></Button>
          </Row>
          <Editor
            language={lang}
            height="100%"
            value={code}
            theme="vs-dark"
            onChange={setCode}
            options={{
              minimap: {
                enabled: false,
              },
              lineNumbers: "off",
            }}
          />
        </Column>
        <CodeSnippetPreview code={code} lang={lang} theme={theme} />
      </Row>
    </Column>
  );
}
